-- ============================================================================
-- VIEW: microdados_ed_basica_refined
-- OBJETIVO: Criar uma visão analítica da base trusted, contendo apenas:
--    (1) colunas de identificação/segmentação da escola
--    (2) 21 campos STATUS_* derivados de flags de inconsistência ou hipótese
--    (3) coluna PROXY_PORTE (porte da escola) para uso em análises exploratórias
-- Cada STATUS_* assume: 'COERENTE', 'INCONSISTENTE' ou 'INCONCLUSIVO'
-- ============================================================================
DROP VIEW IF EXISTS microdados_ed_basica_refined;

CREATE VIEW microdados_ed_basica_refined AS
SELECT
  CO_ENTIDADE,
  NO_ENTIDADE,
  NO_REGIAO,
  SG_UF,
  NO_MUNICIPIO,

  -- Troca do valor numérico pelo significado - Dependência
  CASE
    WHEN TP_DEPENDENCIA = '1' THEN '1 - Federal'
    WHEN TP_DEPENDENCIA = '2' THEN '2 - Estadual'
    WHEN TP_DEPENDENCIA = '3' THEN '3 - Municipal'
    WHEN TP_DEPENDENCIA = '4' THEN '4 - Privada'
    ELSE 'Não informado'
  END AS TP_DEPENDENCIA_TXT,

  -- Troca do valor numérico pelo significado - Localização
  CASE
    WHEN TP_LOCALIZACAO = '1' THEN '1 - Urbana'
    WHEN TP_LOCALIZACAO = '2' THEN '2 - Rural'
    ELSE 'Não informado'
  END AS TP_LOCALIZACAO_TXT,

  -- === PROXY DE PORTE ESCOLAR ===
  -- Critério: Pequena (até 200 matrículas), Média (201 a 500), Grande (acima de 500)
  -- Referência: Padrão do INEP e literatura educacional
  QT_MAT_BAS,
  CASE
    WHEN QT_MAT_BAS <= 200 THEN 'Pequena'
    WHEN QT_MAT_BAS <= 500 THEN 'Média'
    ELSE 'Grande'
  END AS PROXY_PORTE,

-- 1. Declara possuir laboratório de informática, mas não tem energia elétrica pública
CASE
  WHEN IN_LABORATORIO_INFORMATICA IS NULL OR IN_ENERGIA_REDE_PUBLICA IS NULL THEN 'INCONCLUSIVO'
  WHEN IN_LABORATORIO_INFORMATICA = 1 AND IN_ENERGIA_REDE_PUBLICA = 0 THEN 'INCONSISTENTE'
  ELSE 'COERENTE'
END AS STATUS_ERR_FLAG_LABINFO_SEM_ENERGIA,

-- 2. Escola rural sem transporte fornecido pelo estado ou município
CASE
  WHEN TP_LOCALIZACAO IS NULL OR QT_TRANSP_RESP_EST IS NULL OR QT_TRANSP_RESP_MUN IS NULL THEN 'INCONCLUSIVO'
  WHEN TP_LOCALIZACAO = '2' AND QT_TRANSP_RESP_EST = '0' AND QT_TRANSP_RESP_MUN = '0' THEN 'INCONSISTENTE'
  ELSE 'COERENTE'
END AS STATUS_HIP_FLAG_RURAL_SEM_TRANSP,

-- 3. Escola privada com parceria financeira do poder público
CASE
  WHEN TP_DEPENDENCIA IS NULL OR IN_PODER_PUBLICO_PARCERIA IS NULL THEN 'INCONCLUSIVO'
  WHEN TP_DEPENDENCIA = '4' AND IN_PODER_PUBLICO_PARCERIA = 1 THEN 'INCONSISTENTE'
  ELSE 'COERENTE'
END AS STATUS_ERR_FLAG_PRIVADA_VERBA_PUBLICA,

-- 4. Educação infantil presente, mas sem banheiro infantil
CASE
  WHEN IN_INF IS NULL OR IN_BANHEIRO_EI IS NULL THEN 'INCONCLUSIVO'
  WHEN IN_INF = 1 AND IN_BANHEIRO_EI = 0 THEN 'INCONSISTENTE'
  ELSE 'COERENTE'
END AS STATUS_ERR_FLAG_INFANTIL_SEM_BANHEIRO,

-- 5. Possui biblioteca ou sala de leitura, mas sem bibliotecário declarado
CASE
  WHEN IN_BIBLIOTECA IS NULL OR IN_BIBLIOTECA_SALA_LEITURA IS NULL OR IN_PROF_BIBLIOTECARIO IS NULL OR QT_PROF_BIBLIOTECARIO IS NULL THEN 'INCONCLUSIVO'
  WHEN (IN_BIBLIOTECA = 1 OR IN_BIBLIOTECA_SALA_LEITURA = 1) AND (IN_PROF_BIBLIOTECARIO IS NULL OR IN_PROF_BIBLIOTECARIO = 0) AND (QT_PROF_BIBLIOTECARIO IS NULL OR QT_PROF_BIBLIOTECARIO = 0) THEN 'INCONSISTENTE'
  ELSE 'COERENTE'
END AS STATUS_HIP_FLAG_BIBLIOTECA_SEM_BIBLIOTECARIO,

-- 6. Escola declara ter internet, mas não possui computador
CASE
  WHEN IN_INTERNET IS NULL OR IN_COMPUTADOR IS NULL THEN 'INCONCLUSIVO'
  WHEN IN_INTERNET = 1 AND IN_COMPUTADOR = 0 THEN 'INCONSISTENTE'
  ELSE 'COERENTE'
END AS STATUS_ERR_FLAG_INTERNET_SEM_PC,

-- 7. Escola privada declara ofertar alimentação escolar
CASE
  WHEN TP_DEPENDENCIA IS NULL OR IN_ALIMENTACAO IS NULL THEN 'INCONCLUSIVO'
  WHEN TP_DEPENDENCIA = '4' AND IN_ALIMENTACAO = 1 THEN 'INCONSISTENTE'
  ELSE 'COERENTE'
END AS STATUS_ERR_FLAG_ALIMENTACAO_PRIVADA,

-- 8. Ensino médio presente, mas sem professores alocados
CASE
  WHEN IN_MED IS NULL OR QT_DOC_MED IS NULL THEN 'INCONCLUSIVO'
  WHEN IN_MED = 1 AND QT_DOC_MED = 0 THEN 'INCONSISTENTE'
  ELSE 'COERENTE'
END AS STATUS_ERR_FLAG_MEDIO_SEM_PROF,

-- 9. Atendimento educacional especializado sem sala adaptada
CASE
  WHEN IN_ESP IS NULL OR IN_SALA_ATENDIMENTO_ESPECIAL IS NULL THEN 'INCONCLUSIVO'
  WHEN IN_ESP = 1 AND IN_SALA_ATENDIMENTO_ESPECIAL = 0 THEN 'INCONSISTENTE'
  ELSE 'COERENTE'
END AS STATUS_HIP_FLAG_ESP_SEM_SALA_ADAPTADA,

-- 10. Etapa do fundamental declarada, mas sem alunos matriculados
CASE
  WHEN IN_FUND IS NULL OR QT_MAT_FUND IS NULL THEN 'INCONCLUSIVO'
  WHEN IN_FUND = 1 AND QT_MAT_FUND = 0 THEN 'INCONSISTENTE'
  ELSE 'COERENTE'
END AS STATUS_ERR_FLAG_ETAPA_SEM_ALUNO,

-- 11. Escola urbana sem rede pública de esgoto
CASE
  WHEN TP_LOCALIZACAO IS NULL OR IN_ESGOTO_REDE_PUBLICA IS NULL THEN 'INCONCLUSIVO'
  WHEN TP_LOCALIZACAO = '1' AND IN_ESGOTO_REDE_PUBLICA = 0 THEN 'INCONSISTENTE'
  ELSE 'COERENTE'
END AS STATUS_HIP_FLAG_URBANA_SEM_ESGOTO,

-- 12. Oferece alimentação, mas não possui água potável
CASE
  WHEN IN_AGUA_POTAVEL IS NULL OR IN_ALIMENTACAO IS NULL THEN 'INCONCLUSIVO'
  WHEN IN_AGUA_POTAVEL = 0 AND IN_ALIMENTACAO = 1 THEN 'INCONSISTENTE'
  ELSE 'COERENTE'
END AS STATUS_ERR_FLAG_ALIMENTACAO_SEM_AGUA,

-- 13. Possui mediação remota ou semipresencial, mas sem internet
CASE
  WHEN IN_INTERNET IS NULL OR IN_MEDIACAO_EAD IS NULL OR IN_MEDIACAO_SEMIPRESENCIAL IS NULL THEN 'INCONCLUSIVO'
  WHEN IN_INTERNET = 0 AND (IN_MEDIACAO_EAD = 1 OR IN_MEDIACAO_SEMIPRESENCIAL = 1) THEN 'INCONSISTENTE'
  ELSE 'COERENTE'
END AS STATUS_ERR_FLAG_REMOTO_SEM_INTERNET,

-- 14. Tem estudantes com deficiência, mas sem nenhuma estrutura de acessibilidade
CASE
  WHEN IN_ACESSIBILIDADE_RAMPAS IS NULL OR IN_ACESSIBILIDADE_SINALIZACAO IS NULL OR IN_ACESSIBILIDADE_CORRIMAO IS NULL OR QT_MAT_ESP_CC IS NULL OR QT_MAT_ESP_CE IS NULL THEN 'INCONCLUSIVO'
  WHEN IN_ACESSIBILIDADE_RAMPAS = 0 AND IN_ACESSIBILIDADE_SINALIZACAO = 0 AND IN_ACESSIBILIDADE_CORRIMAO = 0 AND (QT_MAT_ESP_CC > 0 OR QT_MAT_ESP_CE > 0) THEN 'INCONSISTENTE'
  ELSE 'COERENTE'
END AS STATUS_HIP_FLAG_PCD_SEM_ACESSIBILIDADE,

-- 15. Possui equipamento multimídia, mas sem energia elétrica
CASE
  WHEN IN_ENERGIA_REDE_PUBLICA IS NULL OR IN_EQUIP_MULTIMIDIA IS NULL THEN 'INCONCLUSIVO'
  WHEN IN_ENERGIA_REDE_PUBLICA = 0 AND IN_EQUIP_MULTIMIDIA = 1 THEN 'INCONSISTENTE'
  ELSE 'COERENTE'
END AS STATUS_ERR_FLAG_MULTIMIDIA_SEM_ENERGIA,

-- 16. Escola rural com internet (hipótese fora do padrão, não necessariamente erro)
CASE
  WHEN TP_LOCALIZACAO IS NULL OR IN_INTERNET IS NULL THEN 'INCONCLUSIVO'
  WHEN TP_LOCALIZACAO = '2' AND IN_INTERNET = 1 THEN 'INCONSISTENTE'
  ELSE 'COERENTE'
END AS STATUS_HIP_FLAG_RURAL_COM_INTERNET,

-- 17. Escola estadual com anos iniciais (eventualmente responsabilidade do município)
CASE
  WHEN TP_DEPENDENCIA IS NULL OR QT_MAT_FUND_AI IS NULL THEN 'INCONCLUSIVO'
  WHEN TP_DEPENDENCIA = '2' AND QT_MAT_FUND_AI > 0 THEN 'INCONSISTENTE'
  ELSE 'COERENTE'
END AS STATUS_HIP_FLAG_ESTADUAL_ANOS_INICIAIS,

-- 18. Escola federal oferecendo educação infantil
CASE
  WHEN TP_DEPENDENCIA IS NULL OR IN_INF IS NULL THEN 'INCONCLUSIVO'
  WHEN TP_DEPENDENCIA = '1' AND IN_INF = 1 THEN 'INCONSISTENTE'
  ELSE 'COERENTE'
END AS STATUS_HIP_FLAG_FEDERAL_INFANTIL,

-- 19. Ausência de esgoto, mas presença de água potável (infraestrutura contraditória)
CASE
  WHEN IN_ESGOTO_REDE_PUBLICA IS NULL OR IN_AGUA_POTAVEL IS NULL THEN 'INCONCLUSIVO'
  WHEN IN_ESGOTO_REDE_PUBLICA = 0 AND IN_AGUA_POTAVEL = 1 THEN 'INCONSISTENTE'
  ELSE 'COERENTE'
END AS STATUS_HIP_FLAG_ESGOTO_NAO_COM_AGUA,

-- 20. Escola marca simultaneamente itens de acessibilidade e ausência total de acessibilidade
CASE
  WHEN IN_ACESSIBILIDADE_RAMPAS IS NULL OR IN_ACESSIBILIDADE_SINALIZACAO IS NULL OR IN_ACESSIBILIDADE_CORRIMAO IS NULL OR IN_ACESSIBILIDADE_INEXISTENTE IS NULL THEN 'INCONCLUSIVO'
  WHEN (IN_ACESSIBILIDADE_RAMPAS = 1 OR IN_ACESSIBILIDADE_SINALIZACAO = 1 OR IN_ACESSIBILIDADE_CORRIMAO = 1) AND IN_ACESSIBILIDADE_INEXISTENTE = 1 THEN 'INCONSISTENTE'
  ELSE 'COERENTE'
END AS STATUS_ERR_FLAG_CONFLITO_ACESSIBILIDADE

FROM microdados_ed_basica_trusted;